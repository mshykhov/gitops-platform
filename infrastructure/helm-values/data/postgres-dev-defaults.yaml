# =============================================================================
# POSTGRESQL CLUSTER DEFAULTS - DEV ENVIRONMENT
# =============================================================================
# Applied to all PostgreSQL clusters in dev environment.
# Service-specific values in <service>-db.yaml override these.
# S3 config injected from apps/values.yaml via ApplicationSet.
# =============================================================================

type: postgresql

version:
  postgresql: "17"

cluster:
  instances: 1

  storage:
    storageClass: longhorn

  # Resources - per CloudNativePG recommendations:
  # https://cloudnative-pg.io/documentation/current/resource_management/
  # Rule: container memory >= 4x shared_buffers (default 128MB = 512Mi min)
  # DEV: minimal resources for development/testing
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 768Mi

  monitoring:
    enabled: true
    podMonitor:
      enabled: true

# =============================================================================
# BACKUPS - Barman to S3 (Cloudflare R2)
# =============================================================================
# Dev: Weekly backup, 7 day retention
# S3 endpoint/bucket injected from apps/values.yaml via ApplicationSet
# =============================================================================
backups:
  enabled: true
  provider: s3
  retentionPolicy: "7d"

  s3:
    path: /
    accessKey: ""
    secretKey: ""

  secret:
    create: false
    name: cnpg-backup-s3

  scheduledBackups:
    - name: weekly
      schedule: "0 0 3 * * 0"
      backupOwnerReference: cluster
      method: barmanObjectStore

  data:
    compression: gzip
    jobs: 1

  wal:
    compression: gzip
    maxParallel: 1

# =============================================================================
# RECOVERY - Pre-configured S3 settings (same as backups)
# =============================================================================
# To restore: set mode: recovery + recovery.clusterName in service values
# S3 endpoint/bucket injected from apps/values.yaml via ApplicationSet
# =============================================================================
recovery:
  method: object_store
  provider: s3
  secret:
    create: false
    name: cnpg-backup-s3
