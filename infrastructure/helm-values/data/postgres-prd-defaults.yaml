# =============================================================================
# POSTGRESQL CLUSTER DEFAULTS - PRD ENVIRONMENT
# =============================================================================
# Applied to all PostgreSQL clusters in prd environment.
# Service-specific values in <service>-db.yaml override these.
# S3 config injected from apps/values.yaml via ApplicationSet.
# =============================================================================

type: postgresql

version:
  postgresql: "17"

cluster:
  # HA: минимум 3 для quorum и fault tolerance
  instances: 3

  storage:
    storageClass: longhorn

  # Resources - per CloudNativePG recommendations:
  # https://cloudnative-pg.io/documentation/current/resource_management/
  # Rule: container memory >= 4x shared_buffers (default 128MB = 512Mi min)
  # PRD: 1Gi allows shared_buffers up to 256MB
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi

  monitoring:
    enabled: true
    podMonitor:
      enabled: true
    prometheusRule:
      enabled: true

  affinity:
    topologyKey: kubernetes.io/hostname

# =============================================================================
# BACKUPS - Barman to S3 (Cloudflare R2)
# =============================================================================
# Docs: https://cloudnative-pg.io/documentation/current/backup/
# S3 endpoint/bucket injected from apps/values.yaml via ApplicationSet
# =============================================================================
backups:
  enabled: true
  provider: s3
  retentionPolicy: "30d"

  s3:
    path: /
    accessKey: ""
    secretKey: ""

  secret:
    create: false
    name: cnpg-backup-s3

  scheduledBackups:
    - name: daily
      schedule: "0 0 2 * * *"
      backupOwnerReference: cluster
      method: barmanObjectStore

  data:
    compression: gzip
    jobs: 2

  wal:
    compression: gzip
    maxParallel: 2

# =============================================================================
# RECOVERY - Pre-configured S3 settings (same as backups)
# =============================================================================
# To restore: set mode: recovery + recovery.clusterName in service values
# S3 endpoint/bucket injected from apps/values.yaml via ApplicationSet
# =============================================================================
recovery:
  method: object_store
  provider: s3
  secret:
    create: false
    name: cnpg-backup-s3
