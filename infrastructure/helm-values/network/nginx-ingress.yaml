# NGINX Ingress Controller
# Docs: https://kubernetes.github.io/ingress-nginx/
# Chart: https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx

controller:
  # ClusterIP - Tailscale Service will expose it
  service:
    type: ClusterIP

  # Ingress class
  ingressClassResource:
    name: nginx
    enabled: true
    default: true

  # Enable for oauth2-proxy auth annotations
  # WARNING: allow-snippet-annotations enables server-snippet in ingress annotations.
  # Required for oauth2-proxy logout redirect (see protected-services/templates/ingresses.yaml).
  # Risk: Untrusted ingress definitions could inject arbitrary nginx config.
  # Mitigation: Only trusted admins can create Ingress resources (RBAC).
  config:
    use-forwarded-headers: "true"
    allow-snippet-annotations: "true"
    annotations-risk-level: "Critical"

  # Resources - increased per Alibaba best practices:
  # https://www.alibabacloud.com/help/en/ack/ack-managed-and-ack-dedicated/user-guide/best-practices-for-the-nginx-ingress-controller
  # Recommendation: CPU limit 1000m+, Memory limit 2Gi+ (or no limits to avoid OOM)
  # For k3s-home single-node: using moderate limits, increase if OOM occurs
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Security
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    runAsGroup: 101

  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE
    readOnlyRootFilesystem: false
